# Lv1 完遂までの残タスク チケット

## 概要
現在の実装状況を踏まえ、Lv1 MVP完遂に向けた残タスクを優先順位別に整理。

## 現在の実装状況 ✅
- [x] Stripe決済統合（基本実装完了）
- [x] モバイルハンバーガーメニューUX修正
- [x] ビルドエラー修正・デプロイ成功
- [x] /v2 リンク修正
- [x] 基本UIコンポーネント
- [x] 認証システム（Clerk）
- [x] データベース設計（Supabase）

---

## 🚨 Critical Priority (P0) - 即座対応必須

### T-001: API エンドポイント修正
**Status:** 未完了 ❌  
**Assignee:** Claude  
**Estimate:** 2-3時間  

**問題:**
- `/api/needs` が 500 エラー
- `/api/proposals/create` が 307 リダイレクト
- 基本的なAPI機能が動作していない

**要件:**
- [ ] `/api/needs` GET エンドポイント修正
- [ ] `/api/proposals/create` POST エンドポイント修正
- [ ] API 認証エラーの解決
- [ ] エラーハンドリングの改善

**検証:**
```bash
curl https://needport.jp/api/needs
curl -X POST https://needport.jp/api/proposals/create
```

---

### T-002: Supabase接続設定確認
**Status:** 未完了 ❌  
**Assignee:** Claude  
**Estimate:** 1時間  

**問題:**
APIエラーの原因がSupabase接続にある可能性

**要件:**
- [ ] Supabase 環境変数設定確認
- [ ] RLS（Row Level Security）ポリシー確認
- [ ] データベーステーブル存在確認
- [ ] 接続テスト実行

---

## 🔥 High Priority (P1) - 今日中対応

### T-003: 決済フロー完全統合テスト
**Status:** 部分完了 ⚠️  
**Assignee:** Claude  
**Estimate:** 3-4時間  

**実装済み:**
- [x] Stripe Checkout Session 作成
- [x] Webhook ハンドリング
- [x] 決済成功・キャンセルページ
- [x] 解放デポジット画面

**要件:**
- [ ] 実際のStripe テストカードでの決済テスト
- [ ] Webhook 受信テスト
- [ ] 決済完了後の状態遷移確認
- [ ] エラーケース（決済失敗、キャンセル）のテスト
- [ ] デポジット金額計算の確認（10%）

**検証手順:**
1. ニーズ投稿 → 提案 → 解放決済 → 成功
2. 決済キャンセルフロー
3. Webhook 受信ログ確認

---

### T-004: 管理者返金機能実装・テスト
**Status:** 未完了 ❌  
**Assignee:** Claude  
**Estimate:** 2-3時間  

**現状:** 
- 返金API は簡素化版で実装済み
- 管理画面での返金操作UI未実装

**要件:**
- [ ] 管理画面での返金申請一覧表示
- [ ] 返金承認・拒否ボタン実装
- [ ] Stripe返金API統合
- [ ] 返金理由・メモ機能
- [ ] 返金完了通知（ログ出力）

**検証:**
管理者としてログイン → 返金申請確認 → 承認実行

---

## 📋 Medium Priority (P2) - 今週中対応

### T-005: メール通知システム完全実装
**Status:** 部分完了 ⚠️  
**Assignee:** Claude  
**Estimate:** 2時間  

**実装済み:**
- [x] Email service 基盤（Log provider）
- [x] 通知テンプレート（提案・チャット・決済完了）

**要件:**
- [ ] 実際のメール通知トリガー統合
- [ ] 通知設定・配信制御
- [ ] メール配信ログ・エラーハンドリング
- [ ] 本番用SendGrid統合準備（Lv2対応）

---

### T-006: チャット機能統合テスト
**Status:** 未確認 ❓  
**Assignee:** Claude  
**Estimate:** 2-3時間  

**要件:**
- [ ] 1:1チャット作成・送信テスト
- [ ] メッセージ表示・既読機能確認
- [ ] リアルタイム通信テスト
- [ ] チャット履歴保存確認
- [ ] 権限制御（他人のチャット閲覧不可）テスト

---

### T-007: プロフィール・マイページ機能確認
**Status:** 未確認 ❓  
**Assignee:** Claude  
**Estimate:** 1-2時間  

**要件:**
- [ ] マイページ各セクション動作確認
- [ ] プロフィール編集機能テスト
- [ ] 案件管理・決済履歴表示確認
- [ ] ニーズ投稿・管理機能テスト

---

## 🔧 Low Priority (P3) - 来週対応

### T-008: セキュリティ・監査ログ確認
**Status:** 未確認 ❓  
**Assignee:** Claude  
**Estimate:** 1-2時間  

**要件:**
- [ ] 監査ログ出力確認
- [ ] アクセス制御テスト
- [ ] CSRF対策確認
- [ ] XSS対策確認

---

### T-009: パフォーマンス・可用性テスト
**Status:** 未実施 ❌  
**Assignee:** Claude  
**Estimate:** 2時間  

**要件:**
- [ ] ページ読み込み速度測定（2秒以内目標）
- [ ] 同時アクセステスト
- [ ] エラー率測定
- [ ] データベース負荷テスト

---

### T-010: 本番環境最終テスト
**Status:** 未実施 ❌  
**Assignee:** Claude  
**Estimate:** 3-4時間  

**要件:**
- [ ] 全機能のE2Eテスト実行
- [ ] 実際のカード決済テスト（少額）
- [ ] 管理者機能テスト
- [ ] セキュリティスキャン実行
- [ ] 本番データバックアップ確認

---

## 📊 完遂判定基準

### 必須機能チェックリスト
- [ ] ニーズ投稿・編集・削除 → **API修正必要**
- [ ] 事業者提案・見積提示 → **API修正必要**
- [ ] 解放デポジット決済（Stripe本番環境） → **テスト必要**
- [ ] 運営主導返金システム → **管理UI実装必要**
- [ ] 1:1チャット機能 → **テスト必要**
- [ ] 地域・カテゴリ検索・絞り込み → **API修正必要**
- [ ] マイページ（案件管理・決済履歴・プロフィール編集） → **テスト必要**
- [ ] 管理画面（ユーザー審査・通報処理・アカウント凍結・監査ログ・返金管理） → **返金管理実装必要**
- [ ] メール通知システム → **統合テスト必要**
- [ ] 自動バックアップ → **確認必要**

### 成功指標（Lv1目標）
- [ ] APIエンドポイント稼働率 > 95%
- [ ] 決済成功率 > 98%
- [ ] ページ読み込み時間 < 2秒
- [ ] 全機能動作確認完了

---

## 🎯 今日のアクションプラン

1. **T-001, T-002 (Critical)**: API修正・Supabase接続確認 → **2-3時間**
2. **T-003 (High)**: 決済フローテスト → **1-2時間**  
3. **T-004 (High)**: 管理者返金機能 → **2時間**

**目標:** 今日中にCritical・High priority完了、明日Lv1完遂

---

## 📝 Notes
- Stripe テストモード使用中（`STRIPE_TEST_MODE=true`）
- Email はログ出力モード（`EMAIL_PROVIDER=log`）
- 現在の主な問題：API層の不具合により基本機能が動作していない